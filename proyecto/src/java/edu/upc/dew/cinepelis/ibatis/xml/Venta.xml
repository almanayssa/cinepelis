<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="Venta" >

     <typeAlias alias="beanCombo" type="edu.upc.dew.cinepelis.common.util.ComboBean"/>
     <typeAlias alias="beanCabeceraVenta" type="edu.upc.dew.cinepelis.model.CabeceraVentaBean"/>
     <typeAlias alias="beanDetalleVenta" type="edu.upc.dew.cinepelis.model.DetalleVentaBean"/>

    <!-- Obtiene la Data del Reporte en una lista de mapas -->
        <select id="getCarteleraForCombo" parameterClass="java.lang.Long" resultClass="beanCombo">
		<![CDATA[
		SELECT CONCAT(p.nombre,' - Sala',c.num_Sala,' - ',c.hora_inicio) as label,CONCAT(c.id_cartelera,'&',c.id_pelicula,'&',c.num_Sala) as code
                FROM tb_cartelera c,tb_pelicula p
                WHERE c.id_pelicula=p.id_pelicula and c.is_activo=1
                ORDER BY p.nombre DESC
		]]>
	</select>

    	<!-- inserta un registro en la tabla tb_venta a partir del beanCabeceraVenta-->
	<insert id="insertCabecera" parameterClass="beanCabeceraVenta">
		<![CDATA[

			INSERT	tb_venta(
				id_cartelera ,
  				id_cliente,
  				id_usuario,
  				fecha_venta,
  				cant_entradas,
  				monto_total
  				)
  			VALUES(
                                #id_cartelera#,
  				#id_cliente#,
  				#id_usuario#,
  				#fecha_venta#,
  				#cant_entradas#,
  				#monto_total#
                             )
		]]>
		<selectKey resultClass="java.lang.Long" keyProperty="id_venta" >
      		select last_insert_id() as id_venta
                </selectKey>
	</insert>

        <!-- inserta un registro en la tabla tb_venta a partir del beanDetalleVenta-->
	<insert id="insertDetalleVenta" parameterClass="beanDetalleVenta">
		<![CDATA[
			INSERT	tb_detalle_venta(
				id_venta ,
  				num_butaca)
  			VALUES( #id_venta#,
  				#num_butaca#)
		]]>
	</insert>


        <select id="listarEntradas" parameterClass="java.lang.Long" resultClass="beanPelicula">
            <![CDATA[
		SELECT @row:=@row + 1 as row, d.*
                FROM tb_detalle_venta d,(SELECT @row:= 0) r
                WHERE d.id_venta = #value#
            ]]>
    </select>


	
</sqlMap>    